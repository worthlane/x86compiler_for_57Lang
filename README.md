# –Ø–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è "57Lang" + –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä –¥–ª—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã x86-64

![](readme_assets/pics/logo.jpg)

### –°–∫–∞—á–∏–≤–∞–Ω–∏–µ (Linux)
```
git clone https://github.com/worthlane/x86compiler_for_57Lang
cd x86_compiler_for_57Lang
make makedirs
make all
```

### –ó–∞–ø—É—Å–∫
```
chmod +x ./run.sh
./run.sh <–∏–º—è —Ñ–∞–π–ª–∞> <—Ñ–ª–∞–≥–∏> ...
```
#### –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–ª–∞–≥–∏
```-log``` - —Å–æ–∑–¥–∞–µ—Ç –ª–æ–≥-—Ñ–∞–π–ª—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã.  
```-s``` - —Å–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª —Å –∞—Å—Å–µ–º–±–ª–µ—Ä–Ω—ã–º –∫–æ–¥–æ–º –¥–ª—è nasm, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª–Ω—è–µ—Ç –∑–∞–¥–∞–Ω–Ω—ã–π –∫–æ–¥.  
```-O0``` - –æ—Ç–∫–ª—é—á–∞–µ—Ç –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–Ω—É—é –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é.  

# –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–Ø–∑—ã–∫](#–Ø–∑—ã–∫)
    1. [–û–ø–∏—Å–∞–Ω–∏–µ](#–û–ø–∏—Å–∞–Ω–∏–µ)
    2. [–°–∏–Ω—Ç–∞–∫—Å–∏—Å](#–°–∏–Ω—Ç–∞–∫—Å–∏—Å-—è–∑—ã–∫–∞)
        1. [–ß–∏—Å–ª–∞](#–ß–∏—Å–ª–∞)
        2. [–û–ø–µ—Ä–∞—Ü–∏–∏](#–û–ø–µ—Ä–∞—Ü–∏–∏)
        3. [–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞](#–ö–ª—é—á–µ–≤—ã–µ-—Å–ª–æ–≤–∞)
    3. [–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞](#–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞)
    4. [–°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã](#–°—Ö–µ–º–∞-—Ä–∞–±–æ—Ç—ã-–ø—Ä–æ–≥—Ä–∞–º–º—ã)
        1. [Frontend](#Frontend)
        2. [Middleend](#Middleend)
        3. [Backend](#Backend)
2. [–ö–æ–º–ø–∏–ª—è—Ç–æ—Ä](#–ö–æ–º–ø–∏–ª—è—Ç–æ—Ä)
    1. [IR](#IR)
          1. [–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?](#–ó–∞—á–µ–º-—ç—Ç–æ-–Ω—É–∂–Ω–æ)
          2. [–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –∏–∑ IR](#–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è-–∏–∑-IR)
    2. [–°–æ–∑–¥–∞–Ω–∏–µ ELF-—Ñ–∞–π–ª–∞](#–°–æ–∑–¥–∞–Ω–∏–µ-ELF-—Ñ–∞–π–ª–∞)
         1. [–ó–∞–≥–æ–ª–æ–≤–∫–∏](#–ó–∞–≥–æ–ª–æ–≤–∫–∏)
         2. [–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞](#–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è-–±–∏–±–ª–∏–æ—Ç–µ–∫–∞)
    3. [–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏](#–°—Ä–∞–≤–Ω–µ–Ω–∏–µ-—Å–∫–æ—Ä–æ—Å—Ç–∏)

## –Ø–∑—ã–∫

### –û–ø–∏—Å–∞–Ω–∏–µ
57Lang - –ø–æ–ª–Ω—ã–π –ø–æ –¢—å—é—Ä–∏–Ω–≥—É —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è.

### –°–∏–Ω—Ç–∞–∫—Å–∏—Å —è–∑—ã–∫–∞
–°–∏–Ω—Ç–∞–∫—Å–∏—Å –º–æ–∂–µ—Ç —á–µ–º-—Ç–æ –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å —è–∑—ã–∫ C++, –Ω–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –º–µ–∂–¥—É –Ω–∏–º–∏ –∏–º–µ–µ—Ç—Å—è –±–æ–ª—å—à–∞—è —Ä–∞–∑–Ω–∏—Ü–∞.
1. –í —è–∑—ã–∫–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π, —Ä–µ–∫—É—Ä—Å–∏–∏, —Ü–∏–∫–ª–æ–≤ –∏ –±–ª–æ–∫–æ–≤ —É—Å–ª–æ–≤–∏–π.
2. –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–º–µ—é—Ç –æ–¥–∏–Ω —Ç–∏–ø. –í –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –º–æ–∂–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –Ω–µ —Ü–µ–ª–æ–µ –∑–Ω–∞–∫–æ–≤–æ–µ —á–∏—Å–ª–æ, –Ω–æ –ø—Ä–∏—Å–≤–æ–∏—Ç—å –µ–π –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Ü–µ–ª–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.
3. –ö–∞–∂–¥–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—è–∑–∞–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ.
4. –í –ø—Ä–æ–≥—Ä–∞–º–º–µ –¥–æ–ª–∂–Ω–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—è —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º ```_0_``` (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ ```main``` –≤ —è–∑—ã–∫–µ –°–∏).
5. –Ø–∑—ã–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–æ–≤ –∏ —É—Å–ª–æ–≤–Ω—ã—Ö –±–ª–æ–∫–æ–≤, –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.

#### –ß–∏—Å–ª–∞
–û–¥–Ω–∞ –∏–∑ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∏–¥–µ–π –ø—Ä–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ —è–∑—ã–∫–∞ - –ø–æ–º–µ–Ω—è—Ç—å –º–µ–∂–¥—É —Å–æ–±–æ–π —Ä–æ–ª—å —Ü–∏—Ñ—Ä –∏ –±—É–∫–≤ –≤ –æ–±—ã—á–Ω—ã—Ö —è–∑—ã–∫–∞—Ö. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –≤—Å–µ —á–∏—Å–ª–∞ –≤ —ç—Ç–æ–º —è–∑—ã–∫–µ –¥–æ–ª–∂–Ω—ã –∑–∞–¥–∞–≤–∞—Ç—å—Å—è —Å–ª–æ–≤–∞–º–∏.

```
0 = zero  
1 = one  
2 = two  
3 = three  
4 = four  
5 = five  
6 = six  
7 = seven  
8 = eight  
9 = nine
```

–í–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ —Å—Ç–∞–Ω–µ—Ç –ø–æ–Ω—è—Ç–Ω–µ–π, –µ—Å–ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã —Ç–∞–∫–∏—Ö —á–∏—Å–µ–ª.

```
57   = five_seven
179  = one_seven_nine
-228 = -two_two_eight
```

#### –û–ø–µ—Ä–∞—Ü–∏–∏
–û–ø–µ—Ä–∞—Ü–∏–∏ –∏–º–µ—é—Ç –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π –≤–∏–¥, –∑–¥–µ—Å—å —É –º–µ–Ω—è –Ω–µ –±—ã–ª–æ –º–æ—Ç–∏–≤–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —É—Å–ª–æ–∂–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—É –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∫–æ–¥–∞ (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç –¥—Ä—É–≥–∏—Ö —á–∞—Å—Ç–µ–πüòàüòàüòà).

```
... * ... - —É–º–Ω–æ–∂–µ–Ω–∏–µ
... / ... - –¥–µ–ª–µ–Ω–∏–µ
... + ... - —Å–ª–æ–∂–µ–Ω–∏–µ
... - ... - –≤—ã—á–∏—Ç–∞–Ω–∏–µ
```

#### –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
–¢–∞–∫ –∫–∞–∫ –≤–º–µ—Å—Ç–æ —Ü–∏—Ñ—Ä –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —á–∏—Å–µ–ª –±—É–∫–≤—ã, —Ç–æ –±—É–¥–µ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —Å –ø–æ–º–æ—â—å—é —Ü–∏—Ñ—Ä –∏ —Å–ø–µ—Ü. –∑–Ω–∞–∫–æ–≤.

```
57?    = if
1000_7 = while
:=     = assignment
$1#    = sinus
57#    = sqrt
<0$    = cosinus
57>>   = input
57<<   = output
57::   = type
~57    = return
@57@   = end
.57    = end of block
```

–ù–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–∞–∫–∂–µ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º —Å–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏. –ü—Ä–∏–º–µ—Ä—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π: ```3```, ```57_23```, ```57$$@_&23321```.

–î–ª—è –±–æ–ª—å—à–µ–π –ø–æ–Ω—è—Ç–Ω–æ—Å—Ç–∏ –ø—Ä–∏–≤–µ–¥—É –ø—Ä–∏–º–µ—Ä –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ —Ä–∞–±–æ—á–µ–≥–æ –∫–æ–¥–∞ –Ω–∞ –°–∏ –∏ –Ω–∞ 57Lang.

C:
```C
int x = 0;
scanf("%d", &x);        // input
if (x == 1337)
{
  while (x)
  {
    x = x - 1;
  }
  printf("%d", x * 10); // output
}
```

57Lang:
```js
57::(1337 := zero)
57>> 1337               // input
57? (1337 == one_three_three_seven)
  1000_7 (1337)
    1337 := 1337 - one
  .57
  57<< 1337 * one_zero  //output
.57
```

–í –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–æ–ª–∂–µ–Ω —Å—Ç–æ—è—Ç—å –∑–Ω–∞–∫ ```@57@```. (–ó–∞–¥–µ–ª –Ω–∞ –±—É–¥—É—â–µ–µ, –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º –∏–∑ –æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞).
–°—Ç–æ–∏—Ç —Ç–∞–∫–∂–µ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ —É—Å–ª–æ–≤–Ω—ã–π –±–ª–æ–∫ –∏–ª–∏ –±–ª–æ–∫ —Ü–∏–∫–ª–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å—Ç—Ä–æ—á–∫–∏ –µ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è, –∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—Å—Ç—Ä–µ—á–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ ```.57```.

–§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:
```js
57::(–Ω–∞–∑–≤–∞–Ω–∏–µ(57::(–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è), 57::(–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è)))
##################################################

// –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏

~57 –∑–Ω–∞—á–µ–Ω–∏–µ // —Ñ—É–Ω–∫—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–ª–∂–Ω–∞—è –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ
##################################################
```

–ö–∞–∫ –≤—ã –º–æ–∂–µ—Ç–µ –≤–∏–¥–µ—Ç—å, –±–ª–æ–∫ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–¥–µ–ª—è–µ—Ç—Å—è –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ä–µ—à–µ—Ç–æ–∫. –≠—Ç–æ —Å–¥–µ–ª–∞–Ω–æ —Ä–∞–¥–∏ —Ç–æ–≥–æ, —á—Ç–æ–±—ã –≤ –±–æ–ª—å—à–æ–º –∫–æ–¥–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–∂–Ω–æ –±—ã–ª–æ —Ä–∞–∑–ª–∏—á–∞—Ç—å –º–µ–∂–¥—É —Å–æ–±–æ–π. –¢–∞–∫ –∫–∞–∫ [–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ª—é–¥–∏](https://github.com/d3clane) –≤—ã—Å–º–µ–∏–≤–∞–ª–∏ —Ç–æ, —á—Ç–æ —è –≤ –∫–æ–Ω—Ç–µ—Å—Ç–µ —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –°–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º –∏–∑ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∏—Ä–µ, —è —Ä–µ—à–∏–ª —Å–¥–µ–ª–∞—Ç—å —ç—Ç—É –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å –≤ —Å–≤–æ–µ–º —è–∑—ã–∫–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π. –ì–æ–≤–Ω–æ–∫–æ–¥–µ—Ä–æ–≤ –±—É–¥–µ—Ç –∫–æ—Ä—ë–∂–∏—Ç—å –æ—Ç —Ç–∞–∫–æ–≥–æ –±–∞–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞, –ø–æ—ç—Ç–æ–º—É –ª—é–¥–∏ –±—É–¥—É—Ç –ø–∏—Å–∞—Ç—å —Ç–æ–ª—å–∫–æ —á–∏—Å—Ç—ã–π –∫–æ–¥.

–î—Ä—É–≥–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ –ø–∞–ø–∫–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º ```examples```. –¢–∞–º —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–∞, —Å—á–∏—Ç–∞—é—â–∞—è —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª —á–∏—Å–ª–∞, –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞, —Ä–µ—à–∞—é—â–∞—è –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ.

#### –ì—Ä–∞–º–º–∞—Ç–∏–∫–∞
–¢–∞–∫ –∫–∞–∫ –∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é [—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ —Å–ø—É—Å–∫–∞](https://ru.wikipedia.org/wiki/–ú–µ—Ç–æ–¥_—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ_—Å–ø—É—Å–∫–∞). –î–ª—è –ª—é–¥–µ–π, –∑–Ω–∞–∫–æ–º—ã—Ö —Å –¥–∞–Ω–Ω—ã–º –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º, –±—É–¥–µ—Ç –ø–æ–ª–µ–∑–Ω–∞ –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞, –ø–æ –∫–æ—Ç–æ—Ä–æ–π —Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∑–∞–¥–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç.
```
// Program          ::= DefFunc Break {DefFunc Break}* END
// DefFunc          ::= Type NewFuncName L_BRACKET FuncVars R_BRACKET {LINE_END}* FUNC_WALL SubProgram FUNC_WALL
// CallVars         ::= L_BRACKET Expr { [,] Expr }* R_BRACKET
// CallFunc         ::= Name CallVars
// FuncVars         ::= OneFuncVar { [,] OneFuncVar }*
// OneFuncVar       ::= Type L_BRACKET Var R_BRACKET
// SubProgram       ::= Block
// WhileSection     ::= WHILE L_BRACKET Expression R_BRACKET {LINE_END}* Block BLOCK_END
// IfSection        ::= IF    L_BRACKET Expression R_BRACKET {LINE_END}* Block BLOCK_END
// Block            ::= {Line Break}*
// Line             ::= {IfSection | WhileSection | Return | Assignment | Init }*
// Init             ::= TYPE L_BRACKET InitialAssignment R_BRACKET
// Assignment       ::= Name ASSIGN Expression
// Return           ::= RETURN Expression
// Expression       ::= AndOperand   { [OR] AndOperand }*
// AndOperand       ::= Comparison   { [AND] Comparison }*
// Comparison       ::= Summ         { [<=>] Summ }*
// Summ             ::= Term         { [ADD SUB] Term }*
// Term             ::= Degree       { [MUL DIV] Degree }*
// Degree           ::= Trigonometry { [^] Trigonometry }*
// Trigonometry     ::=              { [SIN COS] Brackets }*
// Brackets         ::= L_BRACKET Expression R_BRACKET | Component
// Component        ::= [+ -] (Name | Num | CallFunc)
// Type             ::= TYPE
// Break            ::= LINE_END
// Name             ::= NAME
// Num              ::= NUM
```

## –°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã

–°–∞–º–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —Ç—Ä—ë—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö —á–∞—Å—Ç–µ–π:
1. [Frontend](#Frontend) - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–µ—Ä–µ–≤–∞ –æ–ø–µ—Ä–∞—Ü–∏–π.
2. [Middleend](#Middleend) - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è AST-–¥–µ—Ä–µ–≤–∞.
3. [Backend](#Backend) - –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ AST-–¥–µ—Ä–µ–≤–∞ –≤ –±–∏–Ω–∞—Ä–Ω—ã–π –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –ø—Ä–∏ –ø–æ–º–æ—â–∏ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ –ø–æ–¥ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É x86-64.

### Frontend
–ü–µ—Ä–≤–∞—è —Å—Ç–∞–¥–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–¥–∞. –ù–æ —ç—Ç–æ—Ç —ç—Ç–∞–ø —Ç–∞–∫–∂–µ –º–æ–∂–Ω–æ —Ä–∞–∑–±–∏—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å—Ç–µ–π:

–°–Ω–∞—á–∞–ª–∞ –ª–µ–∫—Å–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Ä–∞–∑–±–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –ø—Ä–æ–≥—Ä–∞–º–º—ã –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ "—Å–º—ã—Å–ª–æ–≤—ã–µ –±–ª–æ–∫–∏", —Å–æ–µ–¥–∏–Ω—è—è –Ω–∞–±–æ—Ä —Å–∏–º–≤–æ–ª–æ–≤ –≤ –µ–¥–∏–Ω—É—é –ª–µ–∫—Å–µ–º—É (–µ—â–µ –∏—Ö –Ω–∞–∑—ã–≤–∞—é—Ç —Ç–æ–∫–µ–Ω–∞–º–∏). –¢–∞–∫–∏–º–∏ –ª–µ–∫—Å–µ–º–∞–º–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã, –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ.

![](readme_assets/pics/lexems.jpg)

–ó–∞—Ç–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–π –ø–∞—Ä—Å–µ—Ä –ø—Ä–æ—Ö–æ–¥–∏—Ç—Å—è –ø–æ –ª–µ–∫—Å–µ–º–∞–º –ø—Ä–∏ –ø–æ–º–æ—â–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ —Å–ø—É—Å–∫–∞ –∏ –Ω–∞ –µ–≥–æ –æ—Å–Ω–æ–≤–µ —Å—Ç—Ä–æ–∏—Ç [AST-–¥–µ—Ä–µ–≤–æ](https://ru.wikipedia.org/wiki/–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ–µ_—Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–æ–µ_–¥–µ—Ä–µ–≤–æ) –ø—Ä–æ–≥—Ä–∞–º–º—ã, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑—É—é—â–µ–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –Ω–µ–π.

![](readme_assets/pics/ast.png)

AST-–¥–µ—Ä–µ–≤–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø–∞–ø–∫–µ ```assets```. –í —Ñ–∞–π–ª–µ, –ø–æ–º–∏–º–æ –¥–µ—Ä–µ–≤–∞, —Ç–∞–∫–∂–µ –±—É–¥–µ—Ç –ª–µ–∂–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –Ω–∞ –≤—Ö–æ–¥ —Ñ–∞–π–ª–∞ –±–µ–∑ —É—á–µ—Ç–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è. –°–¥–µ–ª–∞–Ω–æ —ç—Ç–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –±–∏–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ —Å—Ç–∞–¥–∏—è–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–¥–∞.

### Middleend
–ù–∞ –≤—Ç–æ—Ä–æ–π —Å—Ç–∞–¥–∏–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç—Å—è –ø–æ AST-–¥–µ—Ä–µ–≤—É –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ–≤–æ–∑–º–æ–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ—Ç–æ—Ä—ã—Ö –∏–∑–≤–µ—Å—Ç–µ–Ω –∑–∞—Ä–∞–Ω–µ–µ. –¢–æ–≥–¥–∞ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–º—É –∫–æ–¥—É –Ω–µ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Ç—Ä–∞—Ç–∏—Ç—å –≤—Ä–µ–º—è –Ω–∞ —Ä–∞—Å—á–µ—Ç –∏—Ç–∞–∫ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.

–ü—Ä–∏–º–µ—Ä—ã —Ç–∞–∫–∏—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:

```
1 + 1  -> 2
0 * x  -> 0
1 * x  -> x
x / x  -> 1
```

### Backend
–¢—Ä–µ—Ç—å—è (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è) —á–∞—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–¥–∞.

–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç—Å—è –ø–æ AST-–¥–µ—Ä–µ–≤—É –∏ —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç –µ–≥–æ –≤ –∞—Å—Å–µ–º–±–ª–µ—Ä–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã. –í –ø—Ä–æ—à–ª–æ–π –≤–µ—Ä—Å–∏–∏ —è–∑—ã–∫–∞ –Ω–∞ –¥–∞–Ω–Ω–æ–º —ç—Ç–∞–ø–µ –¥–µ—Ä–µ–≤–æ —Ç—Ä–∞–Ω—Å–ª–∏—Ä–æ–≤–∞–ª–æ—Å—å –≤ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –º–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞. –í —ç—Ç–æ—Ç —Ä–∞–∑ —è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª —Å–≤–æ—é –≤–µ—Ä—Å–∏—é –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ –¥–ª—è x86-64, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–∑–¥–∞–µ—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π ELF-—Ñ–∞–π–ª. 

# –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä

## –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã
–ö–∞–∫ –±—ã–ª–æ –Ω–∞–ø–∏—Å–∞–Ω–æ —Ä–∞–Ω–µ–µ, –±—ç–∫–µ–Ω–¥ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å AST-–¥–µ—Ä–µ–≤–æ –≤ –Ω–µ–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—É—é –º—ã —Å–º–æ–∂–µ–º –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –≤ –Ω—É–∂–Ω—ã–µ –Ω–∞–º –∫–æ–º–∞–Ω–¥—ã. –¢–æ –µ—Å—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º–∞ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ç—Ä–∏ —ç—Ç–∞–ø–∞:

1. –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –∏–∑ AST-–¥–µ—Ä–µ–≤–∞ –≤ –º–∞—Å—Å–∏–≤ IR.
2. IR –¥–æ–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω—É–∂–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –±–ª–∞–≥–æ–¥–∞—Ä—è –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ø—Ä–æ—Ö–æ–¥–∞–º.
3. –ó–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π IR —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç—Å—è –≤ –∫–æ–º–∞–Ω–¥—ã –ø–æ–¥ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É x86.

### IR
[IR](https://en.wikipedia.org/wiki/Intermediate_representation#:~:text=An%20intermediate%20representation%20(IR)%20is,such%20as%20optimization%20and%20translation.) - (Intermediate Representation) –ú–∞—Å—Å–∏–≤ —Å—Ç—Ä—É–∫—Ç—É—Ä, —Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏. –≠—Ç–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ –≤ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã, –ø—Ä–æ—Ö–æ–¥—è—Å—å –ø–æ –Ω–µ–º—É, –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞—Å—Å–µ–º–±–ª–µ—Ä–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –ø–æ–¥ –Ω—É–∂–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É. –í –º–æ–µ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ IR-—ç—Ç–æ –º–∞—Å—Å–∏–≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π —Ç–∏–ø–∞ ```instruction_t```.

```C
struct instruction_t
{
    int address;               // insruction address

    InstructionCode code;      // instruction code

    bool   need_patch;         // does instruction need patch
    size_t refer_to;           // refer to other instruction       

    ArgumentType type1;        // first argument type
    int          arg1;         // first argument value

    ArgumentType type2;        // second argument type
    int          arg2;         // second argument value
};
```

#### –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?
–ü–æ—è–≤–ª—è–µ—Ç—Å—è –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω—ã–π –≤–æ–ø—Ä–æ—Å. –ó–∞—á–µ–º –º—ã —Å–Ω–∞—á–∞–ª–∞ —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ–º –¥–µ—Ä–µ–≤–æ –≤ –º–∞—Å—Å–∏–≤ IR, –µ—Å–ª–∏ –≤ —Ç–µ–æ—Ä–∏–∏ –º—ã –º–æ–∂–µ–º —Å—Ä–∞–∑—É —Ç—Ä–∞–Ω—Å–ª–∏—Ä–æ–≤–∞—Ç—å –≤ –∞—Å—Å–µ–º–±–ª–µ—Ä–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã, –∫–∞–∫ –º—ã –¥–µ–ª–∞–ª–∏ —ç—Ç–æ –≤ –ø—Ä–æ—à–ª–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏. –ù–∞ —ç—Ç–æ –µ—Å—Ç—å –∫–∞–∫ –º–∏–Ω–∏–º—É–º 2 –≤–∞–∂–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω—ã.

–í–æ-–ø–µ—Ä–≤—ã—Ö, —ç—Ç–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∞–¥—Ä–µ—Å–æ–≤. –¢–∞–∫–∏—Ö –∫–∞–∫ ```jmp```, ```call``` –∏ —Ç.–ø. –¢–∞–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Ç—Ä–µ–±—É—é—Ç –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –ø–æ –±–∞–π—Ç–∞–º, –∫–æ—Ç–æ—Ä–æ–µ –º—ã –º–æ–∂–µ–º –ø–æ—Å—á–∏—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—É–¥–µ–º –∏–º–µ—Ç—å –ª–∏–Ω–µ–π–Ω—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π. –í IR –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—Å—Ç—Ä–µ—á–∞—è —Ç–∞–∫—É—é –∫–æ–º–∞–Ω–¥—É –º—ã –±—É–¥–µ–º –ø—Ä–∏—Å–≤–∞–∏–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—é ```true``` –¥–ª—è ```need_patch```, –∞ –≤ ```refer_to``` –∫–ª–∞—Å—Ç—å –∏–Ω–¥–µ–∫—Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é —Å—Å—ã–ª–∞–µ—Ç—Å—è —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–∞—è –Ω–∞–º–∏ –∫–æ–º–∞–Ω–¥–∞. –í —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ, –∑–∞–ø–æ–ª–Ω–∏–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é –º–∞—Å—Å–∏–≤ IR –∏ –ø—Ä–µ–¥–ø–æ—Å—á–∏—Ç–∞–≤ –∞–¥—Ä–µ—Å–∞ –µ–≥–æ –∫–æ–º–∞–Ω–¥, –º—ã —Å–º–æ–∂–µ–º –±–ª–∞–≥–æ–¥–∞—Ä—è –µ—â–µ –æ–¥–Ω–æ–º—É –ø—Ä–æ—Ö–æ–¥—É –∑–∞–ø–æ–ª–Ω–∏—Ç—å –¥–æ –∫–æ–Ω—Ü–∞ –∫–æ–º–∞–Ω–¥—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö ```need_patch == true```. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –∑–∞ –∞—Å—Å–∏–º–ø—Ç–æ—Ç–∏–∫—É $O(n)$ –º—ã —Å–º–æ–∂–µ–º –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ –Ω—É–∂–Ω—ã–µ –Ω–∞–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –≤—ã–≤–æ–¥–∞ –≤ –∞—Å—Å–µ–º–±–ª–µ—Ä–Ω—ã–π –∫–æ–¥.

–í–æ-–≤—Ç–æ—Ä—ã—Ö, IR –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ —Å–º–µ–∂–Ω—ã–π —ç—Ç–∞–ø, –¥–ª—è —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ –Ω–µ —Ç–æ–ª—å–∫–æ AST-–¥–µ—Ä–µ–≤–∞, –Ω–æ –∏ –¥—Ä—É–≥–æ–≥–æ –±–∏–Ω–∞—Ä–Ω–æ–≥–æ –∫–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –º–æ–µ–≥–æ [–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞](https://github.com/worthlane/SPU_emulator)) –≤ –±–∏–Ω–∞—Ä–Ω—ã–π –∫–æ–¥ –ø–æ–¥ –Ω–µ–∫—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É. –¢–æ–≥–¥–∞ –Ω–∞–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º–Ω–æ–≥–æ –º–µ–Ω—å—à–µ –ø—Ä–æ–≥—Ä–∞–º–º, –¥–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã —Ç—Ä–∞–Ω—Å–ª–∏—Ä–æ–≤–∞—Ç—å –Ω—É–∂–Ω—ã–π –Ω–∞–º –æ–±—ä–µ–∫—Ç –ø–æ–¥ –Ω—É–∂–Ω—É—é –Ω–∞–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É.

![](readme_assets/pics/ir.jpg)

–ü–æ–º–∏–º–æ —ç—Ç–æ–≥–æ –º—ã –º–æ–∂–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–∫–æ–π –º–∞—Å—Å–∏–≤ –∏–∑ IR, –ø—Ä–æ—Ö–æ–¥—è—Å—å –ø–æ –Ω–µ–º—É –∏ –Ω–∞—Ö–æ–¥—è –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π. –Ø –¥–æ–±–∞–≤–∏–ª –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é, –∑–∞–º–µ–Ω—è—é—â—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ ```push``` –∏ ```pop``` —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏ –Ω–∞ 2 –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ ```nop``` (–∫–æ—Ç–æ—Ä—ã–µ –≤ —Å–ª—É—á–∞–µ IR –Ω–µ –¥–µ–ª–∞—é—Ç –Ω–∏—á–µ–≥–æ –∏ –∑–∞–Ω–∏–º–∞—é—Ç 0 –±–∞–π—Ç –≤ –ª—é–±–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–µ).

### –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –∏–∑ IR

–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –º—ã –ø–æ–ª—É—á–∏–ª–∏ IR –∏–∑ AST-–¥–µ—Ä–µ–≤–∞, –Ω–∞–º –Ω—É–∂–Ω–æ —Ç—Ä–∞–Ω—Å–ª–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ–¥ –æ–¥–Ω—É –∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä. –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ –º—ã –±—É–¥–µ–º —Ç—Ä–∞–Ω—Å–ª–∏—Ä–æ–≤–∞—Ç—å –≤ elf-—Ñ–∞–π–ª –¥–ª—è x86-64. –¢–∞–∫ –∫–∞–∫ –Ω–∞—à IR —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö "–∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã—Ö" –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π, –Ω–∞–º –Ω—É–∂–Ω–æ –∫–∞–∂–¥—É—é –∏–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π, —Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö—Å—è –≤ IR –∑–∞–¥–∞—Ç—å –≤ –∫–∞—á–µ—Å—Ç–≤–µ –æ–¥–Ω–æ–π –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∞—Å—Å–µ–º–±–ª–µ—Ä–Ω—ã—Ö –∫–æ–º–∞–Ω–¥. –Ø –∑–∞–¥–∞—é –ø–µ—Ä–µ–≤–æ–¥ —ç—Ç–∏–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –≤ —Ñ–∞–π–ª–µ ```src/backend/compiler/instructions.h```. –ó–¥–µ—Å—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–¥–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è, –±–ª–∞–≥–æ–¥–∞—Ä—è –∫–æ—Ç–æ—Ä–æ–π –º—ã –º–æ–∂–µ–º –≤—ã–≤–æ–¥–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∫–∞–∫ –≤ ```.s``` —Ñ–∞–π–ª –¥–ª—è nasm (—Ç–∞–∫–æ–π —Ñ–∞–π–ª —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏ —Ñ–ª–∞–≥–µ ```-s``` –≤–æ –≤—Ä–µ–º—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏), —Ç–∞–∫ –∏ —Å—Ä–∞–∑—É –≤ ELF-—Ñ–∞–π–ª.

#### –ö–∞–∫ —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ–º?
–í –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–µ —É –Ω–∞—Å –±—ã–ª–æ –¥–≤–∞ —Å—Ç–µ–∫–∞, –æ–¥–∏–Ω –¥–ª—è –∞–¥—Ä–µ—Å–æ–≤, –∞ –≤—Ç–æ—Ä–æ–π –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (RAM). –¢—Ä–∞–Ω—Å–ª–∏—Ä—É—è –≤ x86 —É –Ω–∞—Å –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Å—Ç—ç–∫. –ï—Å—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã–¥–µ–ª–∏—Ç—å –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ –ø–∞–º—è—Ç—å –ø–æ–¥ –≤—Ç–æ—Ä–æ–π —Å—Ç—ç–∫ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–≤—É–º—è, –Ω–æ —è –ø—Ä–µ–¥–ø–æ—á–µ–ª —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ–¥–Ω–æ–º —Å—Ç—ç–∫–µ, –∞ –∞–¥—Ä–µ—Å–æ–≤–∞—Ç—å—Å—è –∫ –Ω–∏–º —Å –ø–æ–º–æ—â—å—é —Å–º–µ—â–µ–Ω–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ ```rbp```. –î–ª—è —ç—Ç–æ–≥–æ –Ω–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è [—Å—Ç—ç–∫–æ–≤—ã–π —Ñ—Ä–µ–π–º](https://ru.wikipedia.org/wiki/–°—Ç–µ–∫–æ–≤—ã–π_–∫–∞–¥—Ä).

![](readme_assets/pics/stack.jpg)

–û–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –±—É–¥–µ–º –ø—Ä–æ–≤–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ ```XMM``` —Ä–µ–≥–∏—Å—Ç—Ä—ã, –¥–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –Ω–µ—Ü–µ–ª—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö.

#### –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

–¢–∞–∫ –∫–∞–∫ –Ω–µ –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã –≤ IR –º–æ–≥—É—Ç –∏–º–µ—Ç—å —Å–≤–æ–∏ –∞–Ω–∞–ª–æ–≥–∏, —è –Ω–∞–ø–∏—Å–∞–ª —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É, —Å–æ–¥–µ—Ä–∂–∞—â—É—é —Ñ—É–Ω–∫—Ü–∏–∏, –∑–∞–º–µ–Ω—è—é—â–∏—Ö –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã.
–í ```std_lib/stdlib.s``` —Å–æ–¥–µ—Ä–∂–∞—Ç—Å—è —Ç–∞–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∫–∞–∫ ```in```, ```out```, ```hlt```.

### –°–æ–∑–¥–∞–Ω–∏–µ ELF-—Ñ–∞–π–ª–∞

–ó–¥–µ—Å—å –º–Ω–µ –ø—Ä–∏—à–ª–æ—Å—å –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ –∏–∑—É—á–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ ELF-—Ñ–∞–π–ª–∞.  
–ò—Å—Ç–æ—á–Ω–∏–∫–∏: [skyfree](http://www.skyfree.org/linux/references/ELF_Format.pdf), [tchajed](https://github.com/tchajed/minimal-elf), [scratchpad](https://scratchpad.avikdas.com/elf-explanation/elf-explanation.html), [stackoverflow](https://stackoverflow.com/questions/76345246/trying-to-generate-the-smallest-elf-file-possible-in-c)

–ï—Å–ª–∏ –∫—Ä–∞—Ç–∫–æ, —Ç–æ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π ELF-—Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —á–∞—Å—Ç–µ–π:
1. ELF header (—Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ)
2. Program header (—Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ, —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–∞–∫ –∫–æ–¥ —Ç–∞–∫ –∏ –¥–∞–Ω–Ω—ã–µ)
3. –ö–æ–¥ –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ

![](readme_assets/pics/elf.jpg)

#### –ó–∞–≥–æ–ª–æ–≤–∫–∏

–°–æ–∑–¥–∞—Ç—å –Ω—É–∂–Ω—ã–µ –Ω–∞–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –º—ã –º–æ–∂–µ–º –±–ª–∞–≥–æ–¥–∞—Ä—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º ```Elf64_Phdr``` –∏ ```Elf64_Ehdr``` –∏–∑ —Ñ–∞–π–ª–∞ ```elf.h```, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π.

–ú—ã —É–∂–µ –¥–æ–±–∞–≤–∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ```.s``` nasm —Ñ–∞–π–ª–∞. –¢–æ–≥–¥–∞ –º—ã –º–æ–∂–µ–º –µ–≥–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å –∏ —É–∑–Ω–∞—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã ```readelf --all [–∏–º—è —Ñ–∞–π–ª–∞]```. –ó–∞–ø–æ–ª–Ω–∏–º ELF header –Ω—É–∂–Ω—ã–º–∏ –Ω–∞–º –¥–∞–Ω–Ω—ã–º–∏, –Ω–æ —Ç–æ–≥–¥–∞ –æ—Å—Ç–∞–µ—Ç—Å—è —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å program header'–∞–º–∏.

![](readme_assets/pics/proghead.jpg)

–ü–µ—Ä–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º –ø—Ä–∏ –ª—é–±–æ–º –∫–æ–¥–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã, –µ–≥–æ ```memsiz``` –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ program header`–æ–≤ –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è –≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ.  
–í—Ç–æ—Ä–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∫–æ–¥ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ + –∫–æ–¥ —Å–∞–º–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã. –ï–≥–æ ```memsiz``` —Ä–∞–≤–µ–Ω —Å—É–º–º–µ –±–∞–π—Ç–æ–≤, –∑–∞–Ω—è—Ç—ã—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π –∏ –±–∞–π—Ç–æ–≤ –∑–∞–Ω—è—Ç—ã—Ö –∫–æ–¥–æ–º —Å–∞–º–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã.  
–¢—Ä–µ—Ç–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–µ. –†–∑–∞–º–µ—Ä –±–ª–æ–∫–∞ –∑–¥–µ—Å—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π, –∞ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –≤—Å–µ–≥–æ –∫–æ–¥–∞, –Ω–∞ –∞–¥—Ä–µ—Å–µ –∫—Ä–∞—Ç–Ω–æ–º 0x1000.

#### –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –Ω–∞–º –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª –Ω–∞—à—É —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É. –ó–∞—Ä–∞–Ω–µ–µ —Å –ø–æ–º–æ—â—å—é nasm —Å–∫–æ–º–ø–∏–ª–∏—Ä—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –∏ –ø–æ–ª—É—á–∏–º –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª. –£–±–µ—Ä–µ–º –∏–∑ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –æ–ø–∏—Å–∞–Ω–Ω—ã–π —Ä–∞–Ω–µ–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫, —Ç–æ–≥–¥–∞ —É –Ω–∞—Å –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –∫–æ–¥ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ –Ω–µ–π. –î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –±–∏–Ω–∞—Ä–Ω–æ–º —Ñ–∞–π–ª–µ –≤—Å–µ –∑–∞—Ä–∞–±–æ—Ç–∞–ª–æ, –º—ã –¥–æ–ª–∂–Ω—ã –∏—Ö –≤–ø–∏—Å–∞—Ç—å –≤ –ø–æ—Ä—è–¥–∫–µ: –∫–æ–¥ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏, –∑–∞—Ç–µ–º –∫–æ–¥ —Å–∞–º–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã, –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.

> [!WARNING]
> –í–∞–∂–Ω–æ –Ω–µ –∑–∞–±—ã—Ç—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–º–µ—â–µ–Ω–∏—è, –∑–∞–¥–∞–Ω–Ω—ã–µ –Ω–∞–º–∏ –≤ program header'–∞—Ö. –ü—É—Å—Ç–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ —Å—Ç–æ–∏—Ç –∑–∞–ø–æ–ª–Ω–∏—Ç—å –Ω—É–ª—è–º–∏, –ø–æ–∫–∞ –º—ã –Ω–µ –¥–æ–π–¥–µ–º –¥–æ –Ω—É–∂–Ω–æ–≥–æ –Ω–∞–º —Å–º–µ—â–µ–Ω–∏—è.

## –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –º—ã —Å–æ–∑–¥–∞–ª–∏ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π ELF-—Ñ–∞–π–ª. –ü—Ä–æ–≤–µ—Ä–∏–º –Ω–∞—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ —É—Å–∫–æ—Ä–∏—Ç –Ω–∞—à—É –ø—Ä–æ–≥—Ä–∞–º–º—É. –î–ª—è —ç—Ç–æ–≥–æ –Ω–∞–ø–∏—à–µ–º –∫–æ–¥, —Å—á–∏—Ç–∞—é—â–∏–π —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª —á–∏—Å–ª–∞ 5 $10^6$ —Ä–∞–∑. –ó–∞–º–µ—Ä—è—Ç—å –≤—Ä–µ–º—è –±—É–¥–µ–º —Ç—Ä–∏ —Ä–∞–∑–∞ —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã ```time —Ñ–∞–π–ª```. –°—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –±—É–¥–µ–º —Å –ø—Ä–æ—à–ª–æ–π –≤–µ—Ä—Å–∏–µ–π, –≥–¥–µ –º—ã [—ç–º—É–ª–∏—Ä–æ–≤–∞–ª–∏ –∫–æ–¥ –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–µ](https://github.com/worthlane/57Lang). 

|        | $t_1$, —Å | $t_2$, —Å | $t_3$, —Å | $t_{avg}$, —Å |
|:------:|:--------:|:--------:|:--------:|:------------:|
| SPU    | $5.450$  | $5.020$  | $5.025$  | $5.2 \pm 0.3$  |
| x86-64 | 0.098    | 0.096    | 0.103    | $0.100 \pm 0.005$ | 

–ü–æ–ª—É—á–∞–µ–º, —á—Ç–æ —Å –¥–∞–Ω–Ω—ã–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ–º –Ω–∞—à–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ —É—Å–∫–æ—Ä–∏–ª–∞—Å—å –≤ $50 \pm 5$ —Ä–∞–∑! –Ø —Å—á–∏—Ç–∞—é, —á—Ç–æ —ç—Ç–æ –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ü–æ–º–∏–º–æ —ç—Ç–æ–≥–æ –º—ã –µ—â–µ –∏ –≤—ã–∏–≥—Ä–∞–ª–∏ –≤ –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç–∏ —è–∑—ã–∫–∞. –ù–∏ —É –∫–æ–≥–æ –∫—Ä–æ–º–µ –º–µ–Ω—è –Ω–µ —Å–∫–∞—á–∞–Ω –º–æ–π —ç–º—É–ª—è—Ç–æ—Ä –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞, –≤ —Å–≤—è–∑–∏ —Å —á–µ–º –ø—Ä–æ—à–ª—É—é –≤–µ—Ä—Å–∏—é —è–∑—ã–∫–∞ –ø—Ä–æ—Å—Ç–æ –Ω–µ–ª—å–∑—è –±—ã–ª–æ –∏—Å–ø–æ–ª–Ω–∏—Ç—å, –Ω–µ —Å–∫–∞—á–∏–≤–∞—è SPU. –¢–µ–ø–µ—Ä—å –∂–µ –º–æ–π —è–∑—ã–∫ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞ –ª—é–±–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã Linux.






